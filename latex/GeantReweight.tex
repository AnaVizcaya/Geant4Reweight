\setlength{\headheight}{15pt}
\documentclass[12pt]{article}
\usepackage{fancyhdr}
\lhead{}
\chead{}
\rhead{}
\renewcommand{\headrulewidth}{0pt}
\pagestyle{fancy}
\usepackage{graphicx}
\usepackage[top=2cm,bottom=3cm]{geometry}
\usepackage[svgnames]{xcolor}
\usepackage[colorlinks=true,linkcolor=DarkBlue,citecolor=DarkBlue]{hyperref}
\usepackage{xspace}
\usepackage{rotating}
\usepackage{units}
%\usepackage{subfig}
%\usepackage{amssymb, amsmath}
\usepackage{amsmath}
\usepackage{authblk}
\usepackage{lineno}
\usepackage{listings} 
\usepackage[normalem]{ulem}
\usepackage{adjustbox}
%\usepackage{placeins}
\usepackage[section]{placeins}
\usepackage{qtree}
\usepackage{SIunits}
\usepackage{hepunits}
\usepackage{hepparticles}
\usepackage{cancel}
\usepackage{hepnames}
\usepackage{epstopdf}
\usepackage{mathtools}
\usepackage{caption}
\usepackage[aboveskip=-10pt]{subcaption}
\usepackage[capitalise]{cleveref}
\usepackage{braket}
\usepackage{slashed}
\usepackage{subfiles}
\usepackage{graphicx}
\usepackage{textcomp}
\newcommand{\textapprox}{\raisebox{0.5ex}{\texttildelow}}

\newcommand{\todo}[1]{{\color{red} TODO: #1}}
\newcommand\red[1]{{\color{red}#1}}
\newcommand{\ccpi}{CC1$\pi^0$\xspace}
\newcommand{\ccpis}{CC$\pi^0$\xspace}
\newcommand{\ccpip}{CC1$\pi^+$\xspace}
\newcommand{\ncpi}{NC1$\pi^0$\xspace}
\newcommand{\ccqe}{CCQE\xspace}
\newcommand{\mares}{\ensuremath{M_A^\mathrm{res}}\xspace}
\newcommand{\ppi}{\ensuremath{|\mathbf{p}_{\pi^0}|}\xspace}
\newcommand{\mb}{MiniBooNE\xspace}
\newcommand{\minerva}{MINER\ensuremath{\nu}A\xspace}
\newcommand{\neut}{\textsc{neut}\xspace}
\newcommand{\nuance}{\textsc{nuance}\xspace}
\newcommand{\tmu}{\ensuremath{T_{\mu}}\xspace}
\newcommand{\pmu}{\ensuremath{|\textbf{p}_{\mu}|}\xspace}
\newcommand{\cost}{\ensuremath{\cos{\theta_{\mu}}}\xspace}
\newcommand{\enu}{\ensuremath{E_{\nu}}\xspace}
\newcommand{\qq}{\ensuremath{Q^{2}}\xspace}
\newcommand{\qqqe}{\ensuremath{Q^{2}_{\textrm{QE}}}\xspace}
\newcommand{\pf}{\ensuremath{p_{F}}\xspace}
\newcommand{\eb}{\ensuremath{E_{b}}\xspace}
\newcommand{\carb}{C\ensuremath{^{12}}\xspace}
\newcommand{\oxy}{O\ensuremath{^{16}}\xspace}
\newcommand{\ie}{i.e.\xspace}
\newcommand{\eg}{e.g.\xspace}
\newcommand{\ma}{\ensuremath{M_{\textrm{A}}}\xspace}
\newcommand{\maqe}{\ensuremath{M_{\textrm{A}}^{\textrm{QE}}}\xspace}
\newcommand{\numu}{\Pnum}
\newcommand{\nue}{\Pnue}
\newcommand{\numubar}{\APnum}
\newcommand{\nuebar}{\APnue}
\newcommand{\enuqerfg}{\ensuremath{E^{\nu}_{\textrm{QE,RFG}}}\xspace}
\newcommand{\enuqe}{\ensuremath{E^{\nu}_{\textrm{QE}}}\xspace}
\newcommand{\chisq}{\ensuremath{\chi^{2}}\xspace}
\newcommand{\chisqmin}{\ensuremath{\chi^{2}_{\textrm{min}}}\xspace}
\newcommand{\chtwo}{CH\ensuremath{_{2}}\xspace}
\newcommand{\wroclaw}{Wroc{\l}aw\xspace}
\newcommand{\km}{\kilo\meter\xspace}
\newcommand{\m}{\meter\xspace}
\newcommand{\evsq}{\eV\ensuremath{^{2}}\xspace}
\newcommand{\POD}{P{\O}D\xspace}
\newcommand{\ecal}{ECal\xspace}
\newcommand{\ecals}{ECals\xspace}
\newcommand{\dsecal}{Ds-ECal\xspace}
\newcommand{\vol}[4]{\ensuremath{#1\times#2\times\unit{#3}{#4}}\xspace}
\newcommand{\area}[3]{\ensuremath{#1\times\unit{#2}{#3}}\xspace}
\newcommand{\pizero}{\pi^{0}\xspace}
\newcommand{\kg}{\kilo\gram\xspace}
\newcommand{\lep}{\ell}
\newcommand{\mnn}{multi-nucleon--neutrino\xspace}
\newcommand{\elt}{\ensuremath{E_{<}}\xspace}
\newcommand{\egt}{\ensuremath{E_{>}}\xspace}


\renewcommand\Im{\operatorname{Im}}

\graphicspath{{figures/}}

\newif\ifpdf
\ifx\pdfoutput\undefined
   \pdffalse
\else
   \pdfoutput=1
   \pdftrue
\fi
\ifpdf
   \usepackage{graphicx}
   \usepackage{epstopdf}
   %\DeclareGraphicsRule{.eps}{pdf}{.pdf}{`epstopdf #1}
   \pdfcompresslevel=9
\else
   \usepackage{graphicx}
\fi

\graphicspath{{figs/}}


\lstset{backgroundcolor=\color{lightgray}}


\title{GeantReweight \\ 
   \large A Framework for Pion Scattering Reweighting}

\date{}
\begin{document}


\author[1]{Jake Calcutt}
\author[2]{Laura Fields}
\author[1]{Kendall Mahn}
\affil[1]{Michigan State University}
\affil[2]{Fermi National Accelerator Laboratory}

\maketitle
\thispagestyle{fancy}
%\linenumbers
%\begin{abstract}

\section{Motivation}
Errors in neutrino energy estimation serve as large sources of systematic uncertainty in modern neutrino oscillation experiments such as the Deep Underground Neutrino Experiment (DUNE). This estimation relies on the reconstruction of particles, such as pions, produced at the macroscopic neutrino interaction vertex. As the pions travel through the DUNE detector, they possibly undergo secondary interactions within the detector. This allows for misreconstruction and thus errors in the neutrino energy estimation.  It is then crucial to understand the rate of these interactions - the pion interaction cross section - to account for this misreconstruction and misestimation. 

Understanding these interactions on Argon will be important for DUNE, as Liquid Argon serves as its detection medium. Upcoming results from the LArIAT and ProtoDUNE experiments will increase our knowledge of these interactions on Argon, where there is currently limited data. We must also be able to estimate the uncertainty on model predictions used within neutrino detector simulations. The Geant4 software package provides this simulation, but currently has no way of providing an estimation of the uncertainty on its prediction\footnote{There is currently no way for users to easily vary the cross section model short of changing the hard-coded cross section tables by hand.}. I will provide a framework by which one can easily define a varied cross section model, and produce a varied prediction through reweighting. This will allow for varied simulation production without rerunning the simulation, thus saving computing resources and time.

\section{Pion Interactions}
As pions travel through the detector, they can undergo discrete interactions with the nuclei of the detector components. These interactions can largely be separated into elastic scattering, in which the nucleus is left in its ground state, and various reactive/inelastic scattering channels. These can be described by their final states as in Table \ref{tab:fates}. Additionally, in these reactive interaction channels, any number of nucleons (or none) could be knocked out of the nucleus. 

\begin{table}
\begin{center}
  \begin{tabular}{| c | c |}
  \hline
  Channel & Definition  \\  
  \hline	
  Inelastic Scatter & 1 same-charge pion \& no other pions \\
  \hline  
  Absorption & No pions in final state \\
  \hline
  Single Charge Exchange & 1 neutral pion \& no other pions \\
  \hline
  Double Charge Exchange & 1 opposite-charge pion \& no other pions \\
  \hline
  Pion Production & $>$1 pions of any charge \\
  \hline
  \end{tabular}
\end{center}
\caption{Reactive Pion-Nucleus Interactions\label{tab:fates}}
\end{table}

\section{Geant4 Simulation Technique}
Before describing the reweighting process, it is important to understand the way Geant4 handles simulating particles within matter. A user defines the material content and shape of the tracking/detector region, the initial particles to be simulated within the detector, and the set of active physics processes that will be used within the simulation. 

During the simulation, a particle takes a series of steps throughout the detector until it is either killed by some physics process (decaying, certain interactions) or if it leaves the volume. During each step, processes are invoked algorithmically. The processes that describe pion interactions - both Elastic and Inelastic - are chosen to occur based on their interaction cross sections. 

\section{Weighting Scheme}
From here, we can start moving toward a reweighting framework for pion interactions. We should keep in mind that reweighting is essentially \textit{determining the probability for the same thing to happen under a varied model}. 
%This means we will change the following observables in the results of the simulation:
%\begin{enumerate}
%\item How many of each type of process occur\footnote{If we increase the Inelastic cross section, we should expect to see more of those interactions and less stopping or exiting pions.} 
%\item The length traveled before the interactions occur\footnote{If we increase the Inelastic cross section, the pion track lengths should decrease, as inelastic interactions should occur "earlier."}
%\end{enumerate}

Weights will be assigned to an entire track, and according to whether Inelastic or Elastic scatters occur along a track. There will be some divergence in the treatment of Inelastic and Elastic weights due to the fact that Inelastic scatters kill the track\footnote{When an Inelastic interaction is chosen to occur, cascade routines are invoked within the simulation. The initial pion track is terminated. Then, depending on what exits the nucleus as a result of the cascade, a new set of hadrons is created and tracked throughout the macroscopic volume of the simulation.} while Elastic scatters do not. We first consider the treatment of reweighting the Inelastic scattering cross section.

\subsection{Inelastic Ineraction 
Weights}\label{subsec:inel_weights}

Consider a pion travelling through some material with an Inelastic interaction cross section $\sigma$. It has a probability of travelling some small distance, $\delta x$, without undergoing an interaction\footnote{Normally, the number density of the material is stated in this equation, but is baked into the cross section here. Thus, the cross sections discussed here will depend on the surrounding material.}:
\begin{equation}\label{eq:Psurv}
P_{Surv} = e^{- \sigma \delta x} \simeq (1 - \sigma \delta x)
\end{equation}
Accordingly, it has a chance for interacting along that distance:
\begin{equation}\label{eq:Pint}
P_{Int} = \sigma \delta x
\end{equation}

Within Geant4, the pion takes a series steps before the track is terminated. This termination will occur in the following cases:
\begin{enumerate}
\item The pion undergoes an Inelastic interaction
\item It exits the tracking volume
\item It decays in flight
\item It stops within the tracking volume and either decays or is captured
\end{enumerate}
In the context of reweighting the Inelastic cross section, everything but the top case will be considered a surviving track.
Each step will occur with a probability of the form of Equation \ref{eq:Psurv}, giving the following as the total probability for the pion to travel along the entire track without engaging in an Inelastic interaction:
\begin{equation}
P_{Track} =  e^{- \sum \limits_{i} \sigma_i L_i}
\end{equation} 
where $\sigma_i$\footnote{Note that the cross section depends on the pion momentum and the surrounding material at each step. The subscript $i$ reflects this.} and $L_i$ are the Inelastic cross section and the length of the step taken for a given step $i$, and the sum in the exponential is over the set of steps throughout the track.

Thus, for a varied cross section model, a track which does not undergo an Inelastic interaction receives the following weight:
\begin{equation}\label{eq:surv_weight}
  W_{surv} = \frac{e^{- \sum \limits_{i} \sigma'_i L_i}}{e^{- \sum \limits_{i} \sigma_i L_i}}
\end{equation}
Here, $\sigma'_i$ represents the varied set of Inelastic cross sections depending on the surrounding material and pion momentum at each step.

For tracks that end in an Inelastic interaction, the last step will receive a factor of the form of Equation \ref{eq:Pint}. Thus, the track will receive the following weight: 
\begin{equation}\label{eq:int_weight}
  W_{int} = \frac{\sigma'_{last}}{\sigma_{last}} \frac{e^{- \sum \limits_{i} \sigma'_i L_i}}{e^{- \sum \limits_{i} \sigma_i L_i}}
\end{equation}
Where the sums in the exponents now leave out the last step.

%\subsection{Elastic Interaction Weights}
%We now move on to discussing reweighting the Elastic scattering cross section. As mentioned before, the track is not terminated when Elastic scatters occur. This has two effects on the weigthing scheme:
%\begin{enumerate}
%\item The weight is calculated independently of Inelastic scatters
%\item The track can have multiple Elastic scatters before termination, each with associated weighting factors. 
%\end{enumerate}
%
%Because a track will never end in an Elastic scatter, the weight will always contain a term in the form of Equation \ref{eq:surv_weight}. If no elastic scatter occurs, the steps included in the sum span the entire track. For any other number of elastic scatters, those steps span to the end of the track from the step immediately after the last elastic scatter. This accounts for the fact that an elastic scatter did not occur in that range. 
%
%In addition to that 'elastic-survival' factor, multiple weights are assigned from the start of the track to the first elastic scatter and then between any subsequent elastic scatters. These take a similar form to Equation \ref{eq:int_weight}.
%
%The resulting weight then takes the form of:
%\begin{equation}\label{ref:elastFull}
%W_{elast} = \Bigg( \prod \limits_{e} \frac{\sigma_{e}'}{\sigma_{e}} \frac{\exp(-\sum \limits_i^{e-1} L_i  \sigma_{i}')}{\exp(-\sum \limits_i^{e-1} L_i  \sigma_{i})} \Bigg)
%\Bigg( \frac{\exp(-\sum \limits_j^{end} L_j \sigma_{j}')} {\exp(-\sum \limits_j^{end} L_j \sigma_{j})} \Bigg)
%\end{equation}
%Here, all $\sigma$ are the Elastic scattering cross section depending on surrounding material and pion momentum at the denoted step. The product in the first term runs over all of the Elastic scatters throughout the track. The sums in the first term run from either the first step in the track or the first step after each scatter $e$. The sums in the second term run from the step after the last elastic scatter to the end of the track. Essentially, the first term contains the contributions from all of the elastic scatters within the track, while the second term contains the contribution from the steps after the last elastic scatter.

\subsection{Reweighting Final States}
The exclusive channels\footnote{The definitions of these can be found in Table \ref{tab:fates}} of inelastic scattering can also be reweighted. This is done by characterizing the final state of an inelastic scatter by the final state particles\footnote{The final state of an inelastic scatter in Geant is determined by the results of a simulation of the Bertini Cascade model. Delving into the underlying parameters of this Cascade model is currently outside of the scope of this work. Instead, we opt for a post-hoc treatment of the Cascade, and use the fractional populations of final states as the variable parameters.}. 

First, we determine the nominal values for the exclusive cross sections ($\sigma_{i}$ for a specific final state). These will sum to a value equal to the total inelastic cross section $\sigma_{inel} = \sum\limits_{i}\sigma_{i}$. User-defined variations are used to create a set of varied exclusive cross sections $\sigma_{i}'$ and a varied total cross section $\sigma_{inel}'$. In effect, the exclusive and total cross section have associated variation factors as such: $c_{inel}\sigma_{inel}  = \sum\limits_{i} c_{i} \sigma_{i}$. 

From here, the total cross section variation, $c_{inel}$, is used to vary the nominal simulation according to the technique described in Section \ref{subsec:inel_weights}. Events ending in a specific exclusive channel $i$ are given an additional weight $W_{i} = \frac{c_i}{c_{inel}}$. The presence of $c_{inel}$ in the denominator is due to the event already being weighted as an inelastic interaction. 


\section{Software}
GeantReweight consists of several base packages:
\begin{itemize}
	\item \textbf{FitterBase} -- Handles the fitting of Geant's predictions for the total and exclusive cross sections to external data sets.
	\item \textbf{ReweightBase} -- Handles the reweighting of Geant simulation output
	\item \textbf{G4PiCascade} -- Produces root files that store the nominal exclusive and inclusive cross sections. These are used by FitterBase and ReweightBase. 
	\item \textbf{PropBase} -- Handles producing throws using output from FitterBase.
\end{itemize}

\subsection{FitterBase}
The Fitting portion of the software takes in ROOT TGraphs representing the predictions for the inclusive and exclusive cross sections and fits these to data from various experiments.

\subsubsection{G4ReweightFitter}
An instance of the class \textbf{G4ReweightFitter} is created for each experiment/data set. The experiments are separated by probe ($\pi^+$ or $\pi^-$) and nuclear target. To configure, the user provides the following:
\begin{itemize}
	\item Name -- Name of the experiment.
	\item Type -- Represents the target and probe.
	\item Data File -- The location of the ROOT file associated to this data set.
	\item Graphs -- Set of graph names in the ROOT file and their cut types (absorption, charge exchange, etc.).
\end{itemize}

After creating an instance of \textbf{G4ReweightFitter} for an experiment and pointing it to data, the GetMCFromCurves method is used to produce varied predictions given nominal  Geant predictions and a set of user defined parameters (scaling factors for the exclusive channels and the total cross section). Once this is called, the DoFit method will produce the $\chi^2$ value between the data and varied predictions defined as: 

\begin{equation}
\chi^2_{i} = \sum\limits_j^{n_i} \frac{1}{n_i}\left(\frac{\sigma_j^{Data} - \sigma_j^{Geant}}{\Delta\sigma_j^{Data}}\right)^2
\end{equation}

Here, $n_i$ is the number of data points in set $i$, $\sigma^{Data}$ and $\sigma^{Geant}$ are the cross section values from the data and varied Geant respectively. $\Delta\sigma^{Data}$ is the error on the measurement. 

\subsubsection{DUETFitter}
A special version of the \textbf{G4ReweightFitter} class exists for data from the DUET experiment. Unlike the other data included in this project, this data was published along with correlations between the data points for its measurements.CITE The \textbf{DUETFitter} class is derived from \textbf{G4ReweightFitter}, and has its own versions of the constructor, SaveData, and DoFit methods to account for the correlations. The $\chi^2$ produced by DoFit is defined as:

\begin{equation}
\chi^2_{DUET} = \sum\limits_{i,j}^{10}(\sigma^{DUET}_i - \sigma^{Geant}_i)(V_{ij}^{-1})(\sigma^{DUET}_j - \sigma^{Geant}_j)
\end{equation}

Here, $\sigma^{DUET}$ and $\sigma^{Geant}$ are the cross sections from the DUET measurement and the varied Geant prediction. $V_{ij}$ is the DUET correlation matrix.

\subsubsection{G4ReweightCurveFitManager} 

The fit is managed by the \textbf{G4ReweightCurveFitManager} class. The user provides it a set of fit parameters which define the variations to be applied to the Geant predictions. It also defines the set of \textbf{G4ReweightFitter}s to be fit to nominal predictions. The manager calculates the number of degrees of freedom in the fit by using the GetNDOF method from \textbf{G4ReweightFitter}s\footnote{Note: for most of the experiments in the fit, the NDOF is 1 (each are treated as uncorrelated points in the fit). However, DUET provides 10 degrees of freedom (one for each correlated data point).}, summing this, and then subtracting the number of parameters defined for the fit. After defining the experiments to be fit, it creates an instance of a ROOT Minimizer. (MENTION THAT IT'S MIGRAD?) At this point, it either performs the fit with the Minimizer, or runs scans of the fit's $\chi^2$ depending on user input. If the fit is successful at finding a minimum, the manager also draws fit results. 

\subsubsection{Fitter Output}

Once the fit is performed, a ROOT file is saved containing the following:
\begin{itemize}
	\item A histogram of the best fit values and 1 dimensional errors on the parameters.
	\item The fit's resulting covariance matrix.
	\item A tree containing sets of parameter values and their associated $\chi^2$. If the scanning option was chosen, the user can use this tree to draw the results of the scans.
	\item A directory (Data) that holds all of the data used within the fit.
	\item A directory (Fit) that holds:
	\begin{itemize}
		\item The minimum $\chi^2$ value.
		\item A directory for each type (probe, nucleus combination) of experiment containing a set of TCanvas objects. There is one TCanvas for each channel (Reactive, Absorption, etc.) included in the fit for that type of experiment. These display the nominal prediction, best fit, and $\pm 1\sigma$ error bands along with all  data for that experiment type and channel.
	\end{itemize}
    \item If the user configures the manager to do so, a directory is created for each set of parameter values. This directory contains the resulting varied Geant predictions which were used to fit to that experiment's data.
\end{itemize}

\subsubsection{How To Run A Fit}\label{sssec:HowToFit}
The Fitter is configured via FHiCL(CITE). The following is a list of options that are passed to the executable:
\begin{itemize}
	\item OutputFile -- Name of the output file. This can be overridden with the command line option ``-o  filename.root".
	\item FitScan -- Tells the Fitter to run a scan over values of the fit parameters and output the resulting $\chi^2$.
	\item Save -- Tells the Fitter to save a directory for each set of parameter values.
	\item Sets -- A list of FHiCL parameter sets that define where the \textbf{G4ReweightFitters} get the nominal predictions based on the type (probe and nucleus) of the experiment. These have the structure of:
	\begin{itemize}
		\item Name -- What the set is called. This will be referenced by the experiments to access the corresponding predictions.
		\item File -- Location of the file containing the nominal total inelastic cross section from Geant. This is produced by \textbf{G4PiCascade}. (REFERENCE THIS SECTION?)
		\item FSFile -- Location of the file containing the nominal exclusive channel rates from Geant. This is produced by \textbf{G4PiCascade}. (REFERENCE THIS SECTION?)
	\end{itemize}
	\item Experiments -- A list of FHiCL parameter sets defining the individual experiments used within the fit. These have the structure of:
	\begin{itemize}
		\item Name -- Name of the experiment.
		\item Graphs -- A table relating the exclusive channels (reac, abs, cex, abscx, inel, dcex, prod) to their name in the data file.
		\item Data -- Location of the file containing the data for this experiment. 
		\item Type -- Probe and nuclear target. Used to relate experiments to the Geant predictions defined in the Sets parameters above.
	\end{itemize}
	\item ParameterSets -- A list of FHiCL parameter sets defining the fit parameters. These have the structure of:
	\begin{itemize}
		\item Cut -- Which exclusive channel will this be applied to (reac, abs, cex, inel, prod, dcex).
		\item Dummy -- Set to true if you no variation should be applied directly to this channel.
		\item Parameters -- A list of fit parameters that will apply to this channel. These have the following form:
		\begin{itemize}
			\item Name -- Parameter name.
			\item Range -- What momentum values this encompasses.
			\item Nominal -- Starting value of the fit for this parameter. 
		\end{itemize}
    \end{itemize}	 
    
    \item IncludeDUET -- Tells the manager to create and include an instance of\textbf{DUETFitter}.
    \item DUETDataFile -- Tells the \textbf{DUETFitter} where its data is.
    \item MaxCalls -- ROOT Minimizer option: max number of calls in the fit.
    \item Tolerance -- ROOT Minimizer option:
    \item UpperLimit -- ROOT Minimizer option: Maximum value any parameter can take.
    \item LowerLimt -- ROOT Minimizer option: Minimum value any parameter can take.
\end{itemize}

An example of a full set of FHiCL parameters can be found in Appendix \ref{app:FHiCL}.

Once these are set, the user can execute the Fitter using

\begin{lstlisting}
Fitter -c configuration.fcl
\end{lstlisting}

\subsection{ReweightBase}\label{ssec:ReweightBase}

\subsection{G4PiCascade}

\subsection{PropBase}


\section{Testing and Validation - Flat Variations}
The first implemenation of the reweighting consisted of flat variations across all momenta.


\subsection{Thin Target Scattering}
A simulation of pions scattering off a thin target of Liquid Argon was used to extract the pion-Argon scattering cross section. %This was motivated by a master's thesis written by a student on the LArIAT experiment\footnote{Irene Nutini - Study of charged particles interaction processes on Ar in the 0.2 - 2.0 GeV energy range through combined information from ionization free charge and scintillation light}. 
This was checked against Geant4 validation conducted by a previous summer student\footnote{Isaac Harris - Geant4 Liquid Argon Validations}.
The thin target was a disk of .5cm in thickness and 1.5m in radius. Monoenergetic beams\footnote{{50, 100, 150, 200, 250, 300, 400, 500, 600, 700, and 800} MeV } of 1E6 pions were sent toward the target and tracked through the volume. 

The number of elastic scatters and the final fate (i.e. Inelastic Scatter, Decay, Transportation\footnote{Leaving the tracking volume}) of each pion was recorded to determine if an interaction occured. The rate of inelastic scatters ($N_{inel}$)and the number of incident pions ($N_{inc}$) were used to determine the reactive cross section at each energy: 

\begin{equation}\label{ref:reactive_xsec}
\sigma_{reac} = \frac{N_{inel}}{N_{inc}}\frac{1}{Nx}
\end{equation}
Additionally, the total cross section was determined by including the rate of elastic scattering:
\begin{equation}\label{ref:total_xsec}
\sigma_{total} = \frac{N_{scat}}{N_{inc}}\frac{1}{Nx}
\end{equation}
Here, $N_{scat}$ is defined as the number of pions that had any amount of elastic scatters within the volume or whose final fate was an inelastic scatter. 

The simulation was ran with both the nominal inelastic and elastic scattering cross sections, as well as with 3 sets of variations consisting of scaling the inelastic and elastic cross sections separately. These sets are detailed in Table \ref{ref:variations}. 

\begin{center}\label{ref:variations}
  \begin{tabular}{| c | c  c |}
  \hline
  Set & Inelastic Scale & Elastic Scale  \\
  \hline
  1 & 1.5 & 1. \\ 
  \hline
  2 & 1.  & 1.5 \\
  \hline	
  3 & 1.5 & 1.5 \\
  \hline  
  \end{tabular}
\end{center}

Figures \ref{fig:thin_1.5_1} through \ref{fig:thin_1.5_1.5} compare the nominal cross sections to the varied and weighted samples from Table \ref{ref:variations}.


\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/reactive_thin_xsec_inel1.5_elast1}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_thin_xsec_inel1.5_elast1}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/ratio_inel1.5_elast1}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1.5, Elastic Scale: 1}\label{fig:thin_1.5_1}
\end{figure}

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/reactive_thin_xsec_inel1_elast1.5}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_thin_xsec_inel1_elast1.5}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/ratio_inel1_elast1.5}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1, Elastic Scale: 1.5}\label{fig:thin_1_1.5}
\end{figure}

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/reactive_thin_xsec_inel1.5_elast1.5}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_thin_xsec_inel1.5_elast1.5}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/ratio_inel1.5_elast1.5}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1.5, Elastic Scale: 1.5}\label{fig:thin_1.5_1.5}
\end{figure}
\newpage

\subsection{Scattering in a Volume}
In addition to simulated scattering off a thin target, pions were simulated within a LArIAT-sized\footnote{40cm x 47cm x 90cm} volume of LAr. The total and reactive cross sections were extracted via the 'thin-slice method' developed for LArIAT's analysis\footnote{Put in some link here}. This essentially treats the bulk volume of LAr as many subsequent thin targets. Each time the pion enters into a new slice, a new independent thin-target experiment is performed. (CAN ADD MORE EXPLANATIONS LATER)

The results of this are shown in Figures \ref{ref:slice_1.5_1} through \ref{ref:slice_1.5_1.5}

\begin{figure}[htpb]\label{ref:slice_1.5_1}
	\centering
%	\begin{subfigure}[t!]{.45\textwidth}
%		\centering
%		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/reactive_slice_xsec_inel1.5_elast1}.pdf}
%	\end{subfigure}
%	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_slice_xsec_inel1.5_elast1}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/slice_ratio_inel1.5_elast1}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1.5, Elastic Scale: 1}
\end{figure}

\begin{figure}[htpb]\label{ref:slice_1_1.5}
	\centering
%	\begin{subfigure}[t!]{.45\textwidth}
%		\centering
%		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/reactive_slice_xsec_inel1_elast1.5}.pdf}
%	\end{subfigure}
%	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_slice_xsec_inel1_elast1.5}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/slice_ratio_inel1_elast1.5}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1, Elastic Scale: 1.5}
\end{figure}

\begin{figure}[htpb]\label{ref:slice_1.5_1.5}
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_slice_xsec_inel1.5_elast1.5}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/slice_ratio_inel1.5_elast1.5}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1.5, Elastic Scale: 1.5}
\end{figure}

Additionally, the relative rates of pion final states were investigated. This was done by categorizing the pions by their initial kinematics and by whether they underwent an inelastic scatter, any number of elastic scatters, or if they had no interaction before stopping or exiting the volume. For pions that underwent an inelastic scatter, the final state was categorized\footnote{Inelastic scatters also include any number of elastic scatters.}. Table \ref{table:fates} lists the definitions for the various pion fates. The results are shown in Figure \ref{ref:LAr_probs}. %Subsection \ref{subsec:WatAr} shows the results for a similar test in a volume of alternating slabs of LAr and water. 

\newpage

%\subsection{LAr}\label{subsec:LAr}
%\begin{center}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/surv_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/elast_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/inel_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/cex_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/dcex_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/abs_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/prod_LAr}.pdf}
%\end{center}

\begin{figure}[htpb]\label{ref:LAr_probs}
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/surv_LAr}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/elast_LAr}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/inel_LAr}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/cex_LAr}.pdf}
	\end{subfigure}		
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/dcex_LAr}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/abs_LAr}.pdf}
	\end{subfigure}	
	~	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/prod_LAr}.pdf}
	\end{subfigure}			
\caption{Relative fractions of events within LArIAT-like volume }
\end{figure}

%\newpage
%\subsection{WatAr}\label{subsec:WatAr}
%\begin{center}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/surv_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/elast_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/inel_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/cex_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/dcex_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/abs_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/prod_WatAr}.pdf}
%\end{center}
%\newpage

\section{Testing and Validation - Multiple Variations}
In addition to the flat variations, allowing for multiple variations over a momentum range was also implemented. This first came in the form of binned variations, as shown in Figure \ref{fig:binned}\footnote{The variations go to 1 outside of the bin region shown}.  
\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/inel_vars}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/GeantReweight/bin_xsec}.pdf}
	\end{subfigure}
	~	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/GeantReweight/bin_ratio}.pdf}
	\end{subfigure}

\caption{•}\label{fig:binned}
\end{figure}

Additionally, variations according to interpolated between pion momentum were implemented. Figure \ref{fig:func} shows the values of the variations, and the results of the reweighting. 

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/GeantReweight/inel_vars_func}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/GeantReweight/func_xsec}.pdf}
	\end{subfigure}
	~	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/GeantReweight/func_ratio}.pdf}
	\end{subfigure}

\caption{•}\label{fig:func}
\end{figure}

\begin{figure}[htpb]\label{ref:LAr_probs}
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/surv_funced}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/elast_funced}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/inel_funced}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/cex_funced}.pdf}
	\end{subfigure}		
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/dcex_funced}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/abs_funced}.pdf}
	\end{subfigure}	
	~	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/prod_funced}.pdf}
	\end{subfigure}			
\caption{Relative fractions of events within LArIAT-like volume }
\end{figure}

\section{Testing and Validation - Varying Exclusive Channels}\label{subsec:exclusive_validation}
A thin target of Carbon was used to test the exclusive channel reweighting. The setup is identical to the thin target described above, but with a graphite-like material rather than LAr. 

\begin{figure}
	\centering
		\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/reac_exclusive_new}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/inel_exclusive_new}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/abs_exclusive_new}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/cex_exclusive_new}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/dcex_exclusive_new}.pdf}
	\end{subfigure}		
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/prod_exclusive_new}.pdf}
	\end{subfigure}

\caption{Exclusive Reweighting in Carbon }
\end{figure}

\begin{figure}
	\centering
		\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/reac_exclusive_LAr}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/inel_exclusive_LAr}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/abs_exclusive_LAr}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/cex_exclusive_LAr}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/dcex_exclusive_LAr}.pdf}
	\end{subfigure}		
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/exclusive_pdfs/prod_exclusive_LAr}.pdf}
	\end{subfigure}

\caption{Exclusive Reweighting in LAr }
\end{figure}

\section{Edits to Geant4.10.03.p03}

As well as creating the simulation and reweighting packge, I also made edits to Geant4's base code. The edits are summarized here:
\begin{enumerate}
\item Added two extra physics list based off of the G4HadronPhysicsFTFP\_BERT and G4HadronElasticPhysics lists. 
	\begin{enumerate}
	\item These allow the user to specify - at run-time - a factor that scales the inelastic and elastic pion cross sections, respectively. 
	\item Additionally, had to add versions of respective 'particle builder' and 'list constructor' classes. 
	\end{enumerate}
	
\item The G4Step object now contains information related to the various active process names, as well as their mean free paths (dependent on surrounding material and current momentum)
\item Implemented methods in various physics process classes that extract the mean free path of the particle in its current state.
	\begin{enumerate}
	\item The original methods that do this were private within their respective classes, and so could not be called by higher levels of Geant.

	\end{enumerate}
\item Edited the G4SteppingManager to handle extracting information about active processes (name and Mean Free Path) at each step.
	\begin{enumerate}
	\item The last three changes are what enable the reweighting process. The package needs to know the cross section (mean free path) and step length at runtime. 
	\end{enumerate}
\end{enumerate}

\section{What We Need From Geant4 Developers}

\subsection{Releasing GeantReweight}
Two options for releasing this code:
\begin{enumerate}
\item It is released as part of Geant4. It can be integrated into the package in various ways
\item It is released standalone to Geant4.
\end{enumerate}

\subsection{Changes to Geant4}
Both options require specific changes to Geant4's base build:
\begin{enumerate}
\item The G4Step object needs to include:
	\begin{itemize}
	\item Active process names
	\item The current mean free path of each process
	\end{itemize}
	
\item The G4SteppingManager class must place the new information listed in 1. into the G4Step object. 

\item Some methods need to be added or changed from private/protected to public within various hadronic process classes in order to perform 2.
	\begin{itemize}
	\item These are used to extract the mean free path/cross section of the process at a given point in the simulation.
	\end{itemize}	
	
\end{enumerate}

\newpage
\appendix

\section{FHiCL Example}\label{app:FHiCL}

Below is an example of a FHiCL configuration that can be supplied to the Fitter. Note that this example employs FHiCL use of prologs to allow parameters to be taken from multiple files. The explanation of all fields can be found in \ref{ssec:ReweightBase}\\

fit.fcl:
\begin{lstlisting}
  1 #include "sets.fcl"
  2 #include "parameters.fcl"
  3 #include "C_experiments.fcl"
  4 
  5 OutputFile: "example.root"
  6 FitScan: false
  7 Save: false
  8 
  9 #Taken from sets.fcl
 10 Sets: [
 11   @local::C_PiPlus
 12 ]
 13 
 14 #Taken from C_experiments.fcl
 15 Experiments: [ 
 16   @sequence::C_experiments
 17 ]
 18 
 19 #Taken from parameters.fcl
 20 ParameterSet: @local::TheParameters
 21 
 22 IncludeDUET: true
 23 DUETDataFile: "/path/to/DUET.root"
 24 
 25 MaxCalls: 500
 26 Tolerance: 1.e-5
 27 UpperLimit: 2.0
 28 LowerLimit: .5

\end{lstlisting}
\newpage

sets.fcl:
\begin{lstlisting}
  1 BEGIN_PROLOG
  2 
  3 C_PiPlus: {
  4 
  5   Name: "C_PiPlus"
  6 
  7   File: "/path/to/C_PiPlus_cross_section.root"
  8 
  9   FSFile: "/path/to/C_PiPlus_cascade.root"
 10 }
 11 
 12 END_PROLOG
\end{lstlisting}
\newpage

experiments.fcl:
\begin{lstlisting}
  1 BEGIN_PROLOG
  2 
  3 C_experiments: [
  4   {
  5     Name:    "Experiment1_C_PiPlus"
  6     Graphs:  [
  7       ["reac", "C_xsec_reac_piplus"]
  8     ]
  9 
 10     Data:   "/path/to/Experiment1.root"
 11 
 12     Type:   "C_PiPlus"
 13   },
 14 
 15   {
 16     Name:    "Experiment2_C_PiPlus"
 17 
 18     Graphs:  [
 19       ["inel", "C_xsec_inel_piplus"],
 20       ["abscx", "C_xsec_abscx_piplus"]
 21     ]
 22     Data:   "/path/to/Experiment1.root"
 23 
 24     Type:   "C_PiPlus"
 25   }
 26
 27 END_PROLOG
\end{lstlisting}
\newpage 

parameters.fcl:
\begin{lstlisting}
  1 BEGIN_PROLOG
  2 
  3 TheParameters: [
  4   { 
  5     Cut:    "reac"
  6     Dummy: false
  7     Parameters: [
  8       {
  9         Name: "fReacLow"
 10         Range: [10., 200.]
 11         Nominal: 1.0
 12       },
 13       {
 14         Name: "fReacHigh"
 15         Range: [700., 2005.]
 16       }
 17     ]
 18   },
 19   { 
 20     Cut:    "abs"
 21     Dummy: false 
 22     Parameters:  [
 23       {
 24         Name: "fAbs"
 25         Range: [200.0, 700.00]
 26       }
 27     ]
 28   },
 29 
 30   { 
 31     Cut:   "cex"
 32     Dummy: false 
 33     Parameters:  [
 34       { 
 35         Name: "fCex"
 36         Range: [200.0, 700.00]
 37       }
 38     ]
 39   },
 40 
 41   {
 42     Cut:    "inel"
 43     Dummy: false
 44     Parameters:  [
 45       {
 46         Name: "fInel"
 47         Range: [200.0, 700.00]
 48       }
 49     ]
 50   },
 51 
 52   { Cut:    "prod"
 53     Dummy:  true
 54   },
 55 
 56   { Cut:    "dcex"
 57     Dummy:  true
 58   }
 59 ]
 60 
 61 END_PROLOG

\end{lstlisting}

%\section{Interaction Probability Derivation}
%the derivation for the probability of interaction given a cross section
%
%This is essentially the probability for a particle to travel distance L before interacting
%$
%dN = -N \sigma dL \\ 
%\int\frac{dN}{N} = -\int \sigma dL \\
%log(\frac{N}{N_0}) = - \sigma L \\
%\frac{N}{N_0}dL = e^{-\sigma L}dL \\
%$

%\subfile{DUNE_appendix_eff_plots.tex}

%\begin{thebibliography}{7}

%\bibitem{DUNE_CDR1}
%The DUNE Collaboration
%\textit{Long-Baseline Neutrino Facility (LBNF) and Deep Underground Neutrino Experiment (DUNE) Conceptual Design Report Volume 1: The LBNF and DUNE Projects}
%arXiv:1601.05471v1
%
%
%\end{thebibliography}

\end{document}




