\setlength{\headheight}{15pt}
\documentclass[12pt]{article}
\usepackage{fancyhdr}
\lhead{}
\chead{}
\rhead{}
\renewcommand{\headrulewidth}{0pt}
\pagestyle{fancy}
\usepackage{graphicx}
\usepackage[top=2cm,bottom=3cm]{geometry}
\usepackage[svgnames]{xcolor}
\usepackage[colorlinks=true,linkcolor=DarkBlue,citecolor=DarkBlue]{hyperref}
\usepackage{xspace}
\usepackage{rotating}
\usepackage{units}
%\usepackage{subfig}
%\usepackage{amssymb, amsmath}
\usepackage{amsmath}
\usepackage{authblk}
\usepackage{lineno}
\usepackage{listings} 
\usepackage[normalem]{ulem}
\usepackage{adjustbox}
%\usepackage{placeins}
\usepackage[section]{placeins}
\usepackage{qtree}
\usepackage{SIunits}
\usepackage{hepunits}
\usepackage{hepparticles}
\usepackage{cancel}
\usepackage{hepnames}
\usepackage{epstopdf}
\usepackage{mathtools}
\usepackage{caption}
\usepackage[aboveskip=-10pt]{subcaption}
\usepackage[capitalise]{cleveref}
\usepackage{braket}
\usepackage{slashed}
\usepackage{subfiles}
\usepackage{graphicx}
\usepackage{textcomp}
\newcommand{\textapprox}{\raisebox{0.5ex}{\texttildelow}}

\newcommand{\todo}[1]{{\color{red} TODO: #1}}
\newcommand\red[1]{{\color{red}#1}}
\newcommand{\ccpi}{CC1$\pi^0$\xspace}
\newcommand{\ccpis}{CC$\pi^0$\xspace}
\newcommand{\ccpip}{CC1$\pi^+$\xspace}
\newcommand{\ncpi}{NC1$\pi^0$\xspace}
\newcommand{\ccqe}{CCQE\xspace}
\newcommand{\mares}{\ensuremath{M_A^\mathrm{res}}\xspace}
\newcommand{\ppi}{\ensuremath{|\mathbf{p}_{\pi^0}|}\xspace}
\newcommand{\mb}{MiniBooNE\xspace}
\newcommand{\minerva}{MINER\ensuremath{\nu}A\xspace}
\newcommand{\neut}{\textsc{neut}\xspace}
\newcommand{\nuance}{\textsc{nuance}\xspace}
\newcommand{\tmu}{\ensuremath{T_{\mu}}\xspace}
\newcommand{\pmu}{\ensuremath{|\textbf{p}_{\mu}|}\xspace}
\newcommand{\cost}{\ensuremath{\cos{\theta_{\mu}}}\xspace}
\newcommand{\enu}{\ensuremath{E_{\nu}}\xspace}
\newcommand{\qq}{\ensuremath{Q^{2}}\xspace}
\newcommand{\qqqe}{\ensuremath{Q^{2}_{\textrm{QE}}}\xspace}
\newcommand{\pf}{\ensuremath{p_{F}}\xspace}
\newcommand{\eb}{\ensuremath{E_{b}}\xspace}
\newcommand{\carb}{C\ensuremath{^{12}}\xspace}
\newcommand{\oxy}{O\ensuremath{^{16}}\xspace}
\newcommand{\ie}{i.e.\xspace}
\newcommand{\eg}{e.g.\xspace}
\newcommand{\ma}{\ensuremath{M_{\textrm{A}}}\xspace}
\newcommand{\maqe}{\ensuremath{M_{\textrm{A}}^{\textrm{QE}}}\xspace}
\newcommand{\numu}{\Pnum}
\newcommand{\nue}{\Pnue}
\newcommand{\numubar}{\APnum}
\newcommand{\nuebar}{\APnue}
\newcommand{\enuqerfg}{\ensuremath{E^{\nu}_{\textrm{QE,RFG}}}\xspace}
\newcommand{\enuqe}{\ensuremath{E^{\nu}_{\textrm{QE}}}\xspace}
\newcommand{\chisq}{\ensuremath{\chi^{2}}\xspace}
\newcommand{\chisqmin}{\ensuremath{\chi^{2}_{\textrm{min}}}\xspace}
\newcommand{\chtwo}{CH\ensuremath{_{2}}\xspace}
\newcommand{\wroclaw}{Wroc{\l}aw\xspace}
\newcommand{\km}{\kilo\meter\xspace}
\newcommand{\m}{\meter\xspace}
\newcommand{\evsq}{\eV\ensuremath{^{2}}\xspace}
\newcommand{\POD}{P{\O}D\xspace}
\newcommand{\ecal}{ECal\xspace}
\newcommand{\ecals}{ECals\xspace}
\newcommand{\dsecal}{Ds-ECal\xspace}
\newcommand{\vol}[4]{\ensuremath{#1\times#2\times\unit{#3}{#4}}\xspace}
\newcommand{\area}[3]{\ensuremath{#1\times\unit{#2}{#3}}\xspace}
\newcommand{\pizero}{\pi^{0}\xspace}
\newcommand{\kg}{\kilo\gram\xspace}
\newcommand{\lep}{\ell}
\newcommand{\mnn}{multi-nucleon--neutrino\xspace}
\newcommand{\elt}{\ensuremath{E_{<}}\xspace}
\newcommand{\egt}{\ensuremath{E_{>}}\xspace}


\renewcommand\Im{\operatorname{Im}}

\graphicspath{{figures/}}

\newif\ifpdf
\ifx\pdfoutput\undefined
   \pdffalse
\else
   \pdfoutput=1
   \pdftrue
\fi
\ifpdf
   \usepackage{graphicx}
   \usepackage{epstopdf}
   %\DeclareGraphicsRule{.eps}{pdf}{.pdf}{`epstopdf #1}
   \pdfcompresslevel=9
\else
   \usepackage{graphicx}
\fi

\graphicspath{{figs/}}

\title{GeantReweight \\ 
   \large A Framework for Pion Scattering Reweighting}

\date{}
\begin{document}


\author[1]{Jake Calcutt}
%\author[1]{Kendall Mahn}
\affil[1]{Michigan State University}

\maketitle
\thispagestyle{fancy}
%\linenumbers
%\begin{abstract}

\section{Geant4 Simulation Technique}
\subsection{Tracking and Stepping}
The foundation of Geant4's simulation technique is the concept of 'tracking'. In this, particles are transported through media in a series of steps, possibly interacting along the way. Each G4Event starts with a set of G4Tracks. These G4Tracks are dynamic objects whose properties are modified while a manager handles the stepping through a medium. Additionally, they are not containers of multiple G4Steps. Rather, a given G4Step can be thought of existing temporarily, and it is where the main action of tracking occurs. It is up to the user to access the step information via G4StepPoints before and after the stepping. 

A G4SteppingManager handles the stepping. It stores a set of active processes which are instantiated by the user at runtime, thus allowing users to customize which processes are simulated. These processes are implemented in various layers of abstraction, starting at the base virtual class G4VProcess. The second layer is comprised of 3 main 'types' of processes - Rest, Continuous, and Discrete - and combinations of these (i.e. ContinuousDiscrete). The processes continue in varying amounts of abstraction until they are fully defined. The main distinction of the Rest, Continuous, and Discrete processes are whether they have the "DoIt" and "GetPhysicalInteractionLength" defined to occur AtRest, Along-step, or Post-step. Rest processes only occur while the particle is at rest and will largely be ignored for the rest of the discussion. The active Continuous and Discrete processes are handled with the following algorithm:
\begin{enumerate}
	\item Each Continuous and Discrete process propose an interaction length.The smallest interaction length ($L_{min}$) is chosen.
	\item "Safety" ($S$) - the distance to the next boundary - is calculated. %For charged particles without a field or for neutral particles, this is a straight line. Charged particles in fields get a $S$ equal to the arc-length of their path as affected by the field accordingly.
	\item If $L_{min} > S$, the distance to the next volume boundary is re-calculated. 
	\item The smaller of $L_{min}$ and $S$ is taken as the step length. 
	\item All active continuous processes are invoked along the step. The particle's Kinetic Energy will be updated after all invoked processes are completed. The change in Kinetic Eneregy will be the sum of all the contributions.
	\item The G4Track's properties(Kinetic Energy and 4-position) are updated before discrete processes are invoked. At this point, secondary particles created by continuous processes (i.e. ionization electrons) are stored to be given to the G4TrackingManager. 
	\item If, the AtRest procs will be sampled next step. (CHECK THIS. Look in fStep->UpdateTrack?)
	\item If $L_{min}$ was given by a discrete process, it is now invoked.
	\item Track properties are updated. Secondaries are stored.
	\item The track is checked for termination by the invoked discrete process.
	\item The step is finished.
\end{enumerate}


\subsection{Choosing a Process}
As stated in the previous section, each active Continuous and Discrete process propose an interaction length before their invocation. The smallest of these interaction lengths is used as the step length. %Additionally, if a Discrete process proposed it, that process is invoked after all of the Continuous processes. 
It is important to understand how these interaction lengths are proposed and compared to one another.

The Discrete processes do not throw a random number at each step. Rather, each Discrete process simply samples the distribution 
\begin{equation}\label{eq:sample}
P(N) = e^{-N}
\end{equation}
at the beginning of a single track and after each time that process is invoked\footnote{Discrete processes can be further categorized depending on if they kill a track (such as pion-inelastic scattering) or the track is still alive after the process is invoked (hadron-elastic scattering). This will affect the treatment of weights slightly, and will be discussed further in a later section.\label{fn_Discrete}}. This number, $N_{p,s}$ for a given Discrete process at a specific step in the track, is used indirectly in determining the proposed interaction length for that process each step. In a specific step, each active Discrete process has an interaction length $L_{p,s}$ which is determined by the mean free path $\lambda_{p,s}$ of that process as such: 
\begin{equation}
L_{p,s} = N_{p,s} * \lambda_{p,s}
\end{equation}
Each Continuous process also proposes an interaction length. The smallest option out of the Discrete and Continous processes and of the distance to the next boundary is chosen and invoked. If a Discrete process was chosen (and if the track is still alive after invocation), that process has another $N_{p,s}$ sampled from \ref{eq:sample}. Each Discrete process which was not chosen to occur has its own previously-sampled $N_{p,s}$ reduced by an amount equal to $\frac{L_s}{\lambda_{p,s}}$, where $L_s$ is the step length which was chosen in that step\footnote{At this point, $L_s$ is the same for each process, as it is the step that was physically taken.}. These new $N_{p,s}$ are then used in the next step in determining the interaction lengths.

In practice, this results in a \textit{number of interaction lengths} for a given process, where those interaction lengths are constantly updated (due to changes of kinematics or target). This number can be represented as such:

\begin{equation}\label{eq:Nint}
N_p = \sum\limits_{s=steps} \frac{L_s}{\lambda_{p,s}} = \sum\limits_{s=steps} L_s * \sigma_{p,s}
\end{equation}

%It is important to realize the interplay between step sizes and Mean Free Paths. Each process has the same chance of throwing a certain number according to \eqref{eq:1}. However, two processes might throw the same number (unlikely, though instructive), but the deciding factor in a process occuring is based on its Mean Free Paths and the step sizes over the particle's trajectory. This is easily realized when considering $N$ as such:
%\begin{equation}\label{eq:3}
%N = \sum\limits_{s={steps}} \frac{L_{s}}{\lambda_{s}}
%\end{equation}
%or equivalently,
%\begin{equation}\label{eq:4}
%N = \sum\limits_{s={steps}} L_{s} * \sigma_{s}
%\end{equation}
%From this, we can modify \ref{eq:1} as such:
%\begin{equation}\label{eq:5}
%P(\set{L_s} | \set{\sigma_s}) = e^{-\sum L_s * \sigma_s}
%\end{equation}




\section{Weighting Scheme}
From here, we can start moving toward a reweighting framework for pion interactions. We should keep in mind that reweighting is essentially \textit{determining the probability for the same thing to happen under a varied model}. Weights will be assigned when Discrete processes occur, and will change based on the context of what happens. Additionally, as noted in footnote \ref{fn_Discrete}, there will be some divergence in the treatment of Discrete processes that preserve or kill the track. For now, we only consider the processes that kill the track. A singular weight   will be calculated and applied to the track based on the steps it took and the particle's fate when the track is killed.

\subsection{Particle Fates}

We can think of the simulated particle as having two possible fates: it either undergoes an interaction or "survives" after traveling some distance. However, the definition of "survival" needs clarification. In Geant4, the particle will always do \textit{something}, so we should distinguish the fate based on the process that is invoked. Survival processes should then include the pion exiting the world volume (as it is no longer simulated), as well as decaying at rest or being captured at rest. We count the last two as survival processes because they are previously-described AtRest processes which take precendence only once the particle is stopped. Essentially, they require the pion to move a certain distance without interacting, and should be counted as survival processes. 

All other processes\footnote{Such as pion-inelastic scattering, and ... This also includes decaying in flight, as it is treated similar to the rest of the discrete processes in the sampling scheme described above. } 
are considered "interacting" processes. 

\subsection{Assigning Weights}

Now that we have distinguished the interacting and survival processes, we can move on to calculating the weights that should be applied to the tracks. Whether the tracks survive or interact, they receive a weight that effectively changes the probability to have traveled a specific distance - the track's length - without interacting. Classically, this distributions is given by:
\begin{equation}\label{eq:dist_prob}
P(L) \propto e^{-L \sigma}
\end{equation}
By inspection, the exponent is similar to Equation \ref{eq:Nint}, motivating that we can use this in our weighting scheme. Since we would like to change the distribution of distances before an interaction occurs, both interacting and surviving tracks should include this in their weight. For surviving tracks, the weight is solely based on this factor:
\begin{equation}\label{eq:surv_weight}
  W_{surv} = \frac{e^{-\sum L_s  \sigma_{tot,s}'}}{e^{-\sum L_s  \sigma_{tot,s}}}
\end{equation}
Here, $\sigma_{tot,s}$ is the sum of all active discrete cross sections at a given step, and the sums run over the steps in the track. This will change the distribution of track lengths according to the change in the total cross section\footnote{$\sigma_{tot,s}'$ represents the variation of the total cross section, where any or all of the individual cross sections have been varied.}.

Additionally, interacting tracks need to be given a factor that scales their specific fate's probability by the change to the cross section. This would normally be done by a ratio of the new cross section to the old: $\frac{\sigma'}{\sigma}$. However, to account for the cross section changing throughout the particle's travel, as well as variations relative to the kinematics of the track at each step, we use the step-length-averaged cross sections. Thus, we give this additional factor\footnote{The $'$ in the numerator of the first term is there to account for the case that the interaction that occured is weighted. If that interaction was not weighted, $ R = 1$.} to tracks that underwent interaction $a$:

\begin{equation}
\frac{R'}{R} = \frac{\sum L_s \sigma'_a}{\sum L_s \sigma_a}
\end{equation}

Making the total weight applied to interacting tracks:

\begin{equation}\label{eq:int_weight_pop}
  W_{int} = \frac{\sum L_s \sigma'_a}{\sum L_s \sigma_a} * \frac{e^{-\sum L_s  \sigma_{tot,s}'}}{e^{-\sum L_s  \sigma_{tot,s}}}
\end{equation}
This encapsulates both the change to the distribution of track lengths, as well as the relative rates of specific types of interactions. 

\subsection{Track-Preserving Processes - Elastic Scattering}
Certain discrete processes, such as elastic scattering, preserve the track within the simulation run. This means multiple elastic scatters could occur before the track is killed by a different discrete process or if it leaves the tracking volume. To account for this, we keep the calculation of the elastic weight separate from the track-killing processes above. We leave out the elastic cross sections from the calculation of the total cross sections used in the previous section, and we assign multiple elastic weights to the track. In essence, we have to assign a weight whenever another number is resampled after the elastic process occurs. 

The total elastic weight will always contain a term in the form of equation \ref{eq:9}. If no elastic scatter occurs, the steps included in the sum span the entire track. For any other number of elastic scatters, those steps span to the end of the track from the step immediately after the last elastic scatter. This accounts for the fact that an elastic scatter did not occur in that range. 

In addition to that 'elastic-survival' factor, multiple weights are assigned from the start of the track to the first elastic scatter and then between any subsequent elastic scatters. These take a similar form to Equation \ref{eq:int_weight_pop}, but with only a ratio of the varied and nominal individual cross sections.

The resulting weight then takes the form of:
\begin{equation}\label{ref:elastFull}
W_{elast} = (\prod \limits_{elast} \frac{\sum L_s \sigma_s'}{\sum L_s \sigma_s} \frac{e^{-\sum L_s  \sigma_{s}'}}{e^{-\sum L_s  \sigma_{s}}})(\frac{e^{-\sum L_s \sigma_{s}'}}{e^{-\sum L_s \sigma_{s}}})
\end{equation}
Where the $\sigma_s$ corresponds to the cross section for a given elastic-type process at a given step in the track. Note that every such process that is varied would receive this weight, and contribute to the total weight given to the track.

\subsection{Plan for Reweighting Final States}
The fraction of inelastic scatters ending in a specific final state can also be changed\footnote{The final state of an inelastic scatter in Geant is determined by the results of a simulation of the Bertini Cascade model. Delving into the underlying parameters of this Cascade model is currently outside of the scope of this work. Instead, we opt for a post-hoc treatment of the Cascade, and use the fractional populations of final states as the variable parameters.}. First, one must define the nominal values for these fractions ($f_{FS}$ for a specific final state). This will - by definition - satisfy the condition $1 = \sum\limits_{FS} f_{FS}$ Then, knowing the relative populations of the final state, one can assign new fractions to the individual final states. These can be represented, for a specific final state, as $f'_{FS} = v_{FS}f_{FS}$. These will sum to a value $V = \sum\limits_{FS}f'_{FS} = \sum\limits_{FS}v_{FS}f_{FS}$, which may or may not be equal to $1$. Once the new values for the fractions of final states are determined, one can start reweighting the output of a simulation. 

The sample will be reweighted according to the previous sections for a variation in the inelastic scattering cross section such that $\sigma'_{inel} = V\sigma_{inel}$. In addition to the weight received from this method, each inelastic scatter will be scaled by the specific $v_{FS}$ corresponding to the particular final state of the inelastic scatter.


\section{Testing and Validation - Flat Variations}
The first implemenation of the reweighting consisted of flat variations across all momenta.


\subsection{Thin Target Scattering}
A simulation of pions scattering off a thin target of Liquid Argon was used to extract the pion-Argon scattering cross section. %This was motivated by a master's thesis written by a student on the LArIAT experiment\footnote{Irene Nutini - Study of charged particles interaction processes on Ar in the 0.2 - 2.0 GeV energy range through combined information from ionization free charge and scintillation light}. 
This was checked against Geant4 validation conducted by a previous summer student\footnote{Isaac Harris - Geant4 Liquid Argon Validations}.
The thin target was a disk of .5cm in thickness and 1.5m in radius. Monoenergetic beams\footnote{{50, 100, 150, 200, 250, 300, 400, 500, 600, 700, and 800} MeV } of 1E6 pions were sent toward the target and tracked through the volume. 

The number of elastic scatters and the final fate (i.e. Inelastic Scatter, Decay, Transportation\footnote{Leaving the tracking volume}) of each pion was recorded to determine if an interaction occured. The rate of inelastic scatters ($N_{inel}$)and the number of incident pions ($N_{inc}$) were used to determine the reactive cross section at each energy: 

\begin{equation}\label{ref:reactive_xsec}
\sigma_{reac} = \frac{N_{inel}}{N_{inc}}\frac{1}{Nx}
\end{equation}
Additionally, the total cross section was determined by including the rate of elastic scattering:
\begin{equation}\label{ref:total_xsec}
\sigma_{total} = \frac{N_{scat}}{N_{inc}}\frac{1}{Nx}
\end{equation}
Here, $N_{scat}$ is defined as the number of pions that had any amount of elastic scatters within the volume or whose final fate was an inelastic scatter. 

The simulation was ran with both the nominal inelastic and elastic scattering cross sections, as well as with 3 sets of variations consisting of scaling the inelastic and elastic cross sections separately. These sets are detailed in Table \ref{ref:variations}. 

\begin{center}\label{ref:variations}
  \begin{tabular}{| c | c  c |}
  \hline
  Set & Inelastic Scale & Elastic Scale  \\
  \hline
  1 & 1.5 & 1. \\ 
  \hline
  2 & 1.  & 1.5 \\
  \hline	
  3 & 1.5 & 1.5 \\
  \hline  
  \end{tabular}
\end{center}

Figures \ref{fig:thin_1.5_1} through \ref{fig:thin_1.5_1.5} compare the nominal cross sections to the varied and weighted samples from Table \ref{ref:variations}.


\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/reactive_new_thin_xsec_inel1.5_elast1}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_new_thin_xsec_inel1.5_elast1}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/new_ratio_inel1.5_elast1}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1.5, Elastic Scale: 1}\label{fig:thin_1.5_1}
\end{figure}

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/reactive_new_thin_xsec_inel1_elast1.5}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_new_thin_xsec_inel1_elast1.5}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/new_ratio_inel1_elast1.5}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1, Elastic Scale: 1.5}\label{fig:thin_1_1.5}
\end{figure}

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/reactive_new_thin_xsec_inel1.5_elast1.5}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_new_thin_xsec_inel1.5_elast1.5}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/new_ratio_inel1.5_elast1.5}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1.5, Elastic Scale: 1.5}\label{fig:thin_1.5_1.5}
\end{figure}
\newpage

\subsection{Scattering in a Volume}
In addition to simulated scattering off a thin target, pions were simulated within a LArIAT-sized\footnote{40cm x 47cm x 90cm} volume of LAr. The total and reactive cross sections were extracted via the 'thin-slice method' developed for LArIAT's analysis\footnote{Put in some link here}. This essentially treats the bulk volume of LAr as many subsequent thin targets. Each time the pion enters into a new slice, a new independent thin-target experiment is performed. (CAN ADD MORE EXPLANATIONS LATER)

The results of this are shown in Figures \ref{ref:slice_1.5_1} through \ref{ref:slice_1.5_1.5}

\begin{figure}[htpb]\label{ref:slice_1.5_1}
	\centering
%	\begin{subfigure}[t!]{.45\textwidth}
%		\centering
%		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/reactive_slice_xsec_inel1.5_elast1}.pdf}
%	\end{subfigure}
%	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_slice_xsec_inel1.5_elast1}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/slice_ratio_inel1.5_elast1}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1.5, Elastic Scale: 1}
\end{figure}

\begin{figure}[htpb]\label{ref:slice_1_1.5}
	\centering
%	\begin{subfigure}[t!]{.45\textwidth}
%		\centering
%		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/reactive_slice_xsec_inel1_elast1.5}.pdf}
%	\end{subfigure}
%	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_slice_xsec_inel1_elast1.5}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/slice_ratio_inel1_elast1.5}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1, Elastic Scale: 1.5}
\end{figure}

\begin{figure}[htpb]\label{ref:slice_1.5_1.5}
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/total_slice_xsec_inel1.5_elast1.5}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/slice_ratio_inel1.5_elast1.5}.pdf}
	\end{subfigure}
\caption{Inelastic Scale: 1.5, Elastic Scale: 1.5}
\end{figure}

Additionally, the relative rates of pion final states were investigated. This was done by categorizing the pions by their initial kinematics and by whether they underwent an inelastic scatter, any number of elastic scatters, or if they had no interaction before stopping or exiting the volume. For pions that underwent an inelastic scatter, the final state was categorized\footnote{Inelastic scatters also include any number of elastic scatters.}. Table \ref{table:fates} lists the definitions for the various pion fates. The results are shown in Figure \ref{ref:LAr_probs}. %Subsection \ref{subsec:WatAr} shows the results for a similar test in a volume of alternating slabs of LAr and water. 
\begin{center}\label{table:fates}
  \begin{tabular}{| c | c |}
  \hline
  Pion Fate & Definition  \\
  \hline
  No Interaction & No inelastic or elastic scatters \\ 
  \hline
  Elastic Scatters & No inelastic scatter, any number of elastic scatters \\
  \hline	
  Inelastic Scatter & 1 same-charge pion \& no other pions \\
  \hline  
  Absorption & No pions in final state \\
  \hline
  Single Charge Exchange & 1 neutral pion \& no other pions \\
  \hline
  Double Charge Exchange & 1 opposite-charge pion \& no other pions \\
  \hline
  Pion Production & $>$1 pions of any charge \\
  \hline
  \end{tabular}
\end{center}
\newpage

%\subsection{LAr}\label{subsec:LAr}
%\begin{center}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/surv_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/elast_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/inel_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/cex_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/dcex_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/abs_LAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/prod_LAr}.pdf}
%\end{center}

\begin{figure}[htpb]\label{ref:LAr_probs}
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/surv_LAr}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/elast_LAr}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/inel_LAr}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/cex_LAr}.pdf}
	\end{subfigure}		
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/dcex_LAr}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/abs_LAr}.pdf}
	\end{subfigure}	
	~	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/prod_LAr}.pdf}
	\end{subfigure}			
\caption{Relative fractions of events within LArIAT-like volume }
\end{figure}

%\newpage
%\subsection{WatAr}\label{subsec:WatAr}
%\begin{center}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/surv_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/elast_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/inel_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/cex_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/dcex_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/abs_WatAr}.pdf}
%\includegraphics[width=.75\textwidth]{{/home/jake/comp_pdfs/probs/prod_WatAr}.pdf}
%\end{center}
%\newpage

\section{Testing and Validation - Multiple Variations}
In addition to the flat variations, allowing for multiple variations over a momentum range was also implemented. This first came in the form of binned variations, as shown in Figure \ref{fig:binned}\footnote{The variations go to 1 outside of the bin region shown}.  
\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/inel_vars}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/GeantReweight/bin_xsec}.pdf}
	\end{subfigure}
	~	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/GeantReweight/bin_ratio}.pdf}
	\end{subfigure}

\caption{•}\label{fig:binned}
\end{figure}

Additionally, variations according to interpolated between pion momentum were implemented. Figure \ref{fig:func} shows the values of the variations, and the results of the reweighting. 

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/GeantReweight/inel_vars_func}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/GeantReweight/func_xsec}.pdf}
	\end{subfigure}
	~	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/GeantReweight/func_ratio}.pdf}
	\end{subfigure}

\caption{•}\label{fig:func}
\end{figure}

\begin{figure}[htpb]\label{ref:LAr_probs}
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/surv_funced}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/elast_funced}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/inel_funced}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/cex_funced}.pdf}
	\end{subfigure}		
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/dcex_funced}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/abs_funced}.pdf}
	\end{subfigure}	
	~	
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/comp_pdfs/probs/func/prod_funced}.pdf}
	\end{subfigure}			
\caption{Relative fractions of events within LArIAT-like volume }
\end{figure}

\section{Edits to Geant4.10.03.p03}

As well as creating the simulation and reweighting packge, I also made edits to Geant4's base code. The edits are summarized here:
\begin{enumerate}
\item Added two extra physics list based off of the G4HadronPhysicsFTFP\_BERT and G4HadronElasticPhysics lists. 
	\begin{enumerate}
	\item These allow the user to specify - at run-time - a factor that scales the inelastic and elastic pion cross sections, respectively. 
	\item Additionally, had to add versions of respective 'particle builder' and 'list constructor' classes. 
	\end{enumerate}
	
\item The G4Step object now contains information related to the various active process names, as well as their mean free paths (dependent on surrounding material and current momentum)
\item Implemented methods in various physics process classes that extract the mean free path of the particle in its current state.
	\begin{enumerate}
	\item The original methods that do this were private within their respective classes, and so could not be called by higher levels of Geant.

	\end{enumerate}
\item Edited the G4SteppingManager to handle extracting information about active processes (name and Mean Free Path) at each step.
	\begin{enumerate}
	\item The last three changes are what enable the reweighting process. The package needs to know the cross section (mean free path) and step length at runtime. 
	\end{enumerate}
\end{enumerate}

\section{What We Need From Geant4 Developers}

\subsection{Releasing GeantReweight}
Two options for releasing this code:
\begin{enumerate}
\item It is released as part of Geant4. It can be integrated into the package in various ways
\item It is released standalone to Geant4.
\end{enumerate}

\subsection{Changes to Geant4}
Both options require specific changes to Geant4's base build:
\begin{enumerate}
\item The G4Step object needs to include:
	\begin{itemize}
	\item Active process names
	\item The current mean free path of each process
	\end{itemize}
	
\item The G4SteppingManager class must place the new information listed in 1. into the G4Step object. 

\item Some methods need to be added or changed from private/protected to public within various hadronic process classes in order to perform 2.
	\begin{itemize}
	\item These are used to extract the mean free path/cross section of the process at a given point in the simulation.
	\end{itemize}	
	
\end{enumerate}




%\appendix
%\section{Interaction Probability Derivation}
%the derivation for the probability of interaction given a cross section
%
%This is essentially the probability for a particle to travel distance L before interacting
%$
%dN = -N \sigma dL \\ 
%\int\frac{dN}{N} = -\int \sigma dL \\
%log(\frac{N}{N_0}) = - \sigma L \\
%\frac{N}{N_0}dL = e^{-\sigma L}dL \\
%$

%\subfile{DUNE_appendix_eff_plots.tex}

%\begin{thebibliography}{7}

%\bibitem{DUNE_CDR1}
%The DUNE Collaboration
%\textit{Long-Baseline Neutrino Facility (LBNF) and Deep Underground Neutrino Experiment (DUNE) Conceptual Design Report Volume 1: The LBNF and DUNE Projects}
%arXiv:1601.05471v1
%
%
%\end{thebibliography}

\end{document}




